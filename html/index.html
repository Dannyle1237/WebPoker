<!doctype html>
<html>
<meta charset="utf-8">

<head>
  <title>WebPoker Game</title>
  <link rel = "stylesheet" href="styles.css" >
  <p class = "title" id = "title"> Welcome to our WebPoker Game!</p>

</head>

<body>
  <div id = "beginning" >
    <div id = "tutorial" class = "overlay">
      <a href="javascript:void(0)" class="closebtn" onmousedown = "closeTutorial()">&times;</a>
      <div class = "tutorial_content">
        <p style = "font-weight:bold; font-size:80px">Five-Card Draw Tutorial</p> 
        <p class = "heading">Ranking System (Best to Worst)</p>
        <p class = "content_rules">
          1. Straight Flush - 5 cards of same suit in numeric sequence<br>
          2. Four of a Kind - 4 cards of matching value<br>
          3. Full House - 3 of a kind & a pair of another<br>
          4. Flush - 5 cards of matching suit<br>
          5. Straight - 5 cards of any suit in numeric sequence<br>
          6. Three of a Kind - 3 cards of matching value<br>
          7. Two Pair - 2 pairs of matching value<br>
          8. Pair - 1 pair of matching value<br>
          9. High Card - highest valued card wins if no better hand is made<br>
        </p>
        <p class = "heading">5 Card Draw vs Texas Hold Em Main Differences</p>
        <p class = "content_rules">
          - Initially must provide a mandatory bet known as Ante (varies)<br>
          - No community pool of cards<br>
          - Restricted to the initial 5 cards you are dealt<br>
          - Through 4 rounds, players can make bets and get rid of cards to strengthen their hands<br>
        </p>
        <p class = "heading">4 Total Rounds</p>
        <p class = "content_rules">
          1. 1st Betting Round<br>
          2. Draw Round - players can get rid of cards to get new ones<br>
          3. 2nd Betting Round<br>
          4. Showdown - best hand wins; winner takes all<br>
        </p>
        <p class = "heading">Betting Rounds (Round 1 & 3)</p>
        <p class = "content_rules">
          - You are able to check, call, raise, or fold like Texas Hold Em<br>
          - If everyone checks in first round, it automatically adds additional ante from everyone<br>
          Draw Round (Round 2)<br>
          - Ask dealer to replace cards in your hand (which ones and how many)<br>
          - Max number to replace usually being 3 but other variations exist such as:<br>
          - 4 Max if 5th is a wild cards (Ace)<br>
          - No limit, flush entire hand to get new set of cards<br>
          - Give dealer your cards concealed (All card “transactions” are concealed essentially)<br>
          - Not obligated to draw any new cards, you can decline i.e., Standing Pat, not taking any<br>
          new cards in the draw<br>
        </p>
        <p class = "heading">Other Rules</p>
        <p class = "content_rules">
          - First option goes to player left of dealer, whether to check or bet<br>
          - Check: Forgo option to make a bet to the next player to the left<br>
          - Bet: Make a bet (there may be pot limits at a table)
        </p>

      </div>
    </div>

    <div class= = "container">
      <div class = "row">
        <div class = "column" id = "player1" style = "visibility:hidden" >
          <img src = "PlayerPicture.png" style = "width:100%">
          <span class = "player_name" id = "player1_name" >name here</span>
        </div>
        <div class = "column" id = "player2" style = "visibility:hidden" >
          <img src = "PlayerPicture.png" style = "width:100%">
          <span class = "player_name" id = "player2_name">name here</span>
        </div>
        <div class = "column" id = "player3" style = "visibility:hidden" >
          <img src = "PlayerPicture.png" style = "width:100%">
          <span class = "player_name" id = "player3_name">name here</span>
        </div>
        <div class = "column" id = "player4" style = "visibility:hidden" >
          <img src = "PlayerPicture.png" style = "width:100%">
          <span class = "player_name" id = "player4_name">name here</span>
        </div>
        <div class = "column" id = "player5" style = "visibility:hidden" >
          <img src = "PlayerPicture.png" style = "width:100%">
          <span class = "player_name" id = "player5_name">name here</span>      
        </div>
      </div>
    </div>

    <p class = "lobby">
      <input class = "input_box" id="send_name" type="text" placeholder = "Enter name here">
      <input class = "lobby_button" id = "join_button" type="button" name="join_button" value="Join" onclick="join()">
      <input class = "lobby_button" id = "tutorial_button" type="button" name="tutorial_button" value="Tutorial" onclick="tutorial()">
      <label class="switch" id = "switch" style = "visibility:hidden">
        <input type="checkbox" id = "ready_switch" onclick ="ready()">
        <span class="slider round">YES   NO</span>
      </label>
    </p>
    <div style = "font-size: 25px" class = "textbox" id="textbox">
    </div>

    <div class = "overlay" id = "timer_overlay" >
      <div class = "timer_content" >
        <p class = "timer" id = "timer">Game starting: 5</p>
      </div>
    </div>
  </div>
  <div id = "middle" style = "display:none">
    <div class="centerpot">
      <p id = "Pot">Pot: $10</p>
      <p id = "Call">Call: $0</p>
      <button class = "playable_button" id = "check_button" onclick = "check()">Check</button>
      <button class = "playable_button" id = "call_button"  onclick = "callFunct()">Call</button>
      <button class = "playable_button" id = "fold_button"  onclick = "fold()">Fold</button>
      <input id="raise_amount" type="number" placeholder = "Enter amount to raise">
      <button class = "playable_button" id = "raise_button" onclick = "raise()">Raise</button>
      <button id = "swap_button" onclick = "sendSwap()" disabled = "true">Click when done choosing cards</button>
    </div>
    
    <div class="usercards">
      <img id="card1" src="3C.svg" style="width:130px;" onclick = "swap(this)">
      <img id="card2" src="3D.svg" style="width:130px;" onclick = "swap(this)">
      <img id="card3" src="3H.svg" style="width:130px;" onclick = "swap(this)">
      <img id="card4" src="4C.svg" style="width:130px;" onclick = "swap(this)">
      <img id="card5" src="5C.svg" style="width:130px;" onclick = "swap(this)">
    </div>
    
    <div class="topplayercards">
      <img id="pCard1" src="2B.svg" style="width:130px;">
      <img id="pCard2" src="2B.svg" style="width:130px;">
      <img id="pCard3" src="2B.svg" style="width:130px;">
      <img id="pCard4" src="2B.svg" style="width:130px;">
      <img id="pCard5" src="2B.svg" style="width:130px;">
    </div>
    <div class="leftside">
      <img class="sidecard1 rotate" id="card5" src="2B.svg" style="width:100px;">
      <img class="sidecard2 rotate" id="card5" src="2B.svg" style="width:100px;">
      <img class="sidecard3 rotate" id="card5" src="2B.svg" style="width:100px;">
      <img class="sidecard4 rotate" id="card5" src="2B.svg" style="width:100px;">
      <img class="sidecard5 rotate" id="card5" src="2B.svg" style="width:100px;">
    </div>
    <div class="rightside">
      <img class="sidecard1 rotate" id="card5" src="2B.svg" style="width:100px;">
      <img class="sidecard2 rotate" id="card5" src="2B.svg" style="width:100px;">
      <img class="sidecard3 rotate" id="card5" src="2B.svg" style="width:100px;">
      <img class="sidecard4 rotate" id="card5" src="2B.svg" style="width:100px;">
      <img class="sidecard5 rotate" id="card5" src="2B.svg" style="width:100px;">
    </div>
    <div class="balancedisplay">
      <p id = "Balance">Balance: $1000</p>
    </div>
  </div>
</body>
</html>

<script>
  var connection = null;

  var serverUrl;
  serverUrl ="ws://" + window.location.hostname + ":8880";
  console.log("URL IS " + serverUrl);
  connection = new WebSocket(serverUrl);
  connection.onopen = function (evt) {
    console.log("open");
  }

  var cardIdx = 0;
  var playerID = 0;
  var started = false;
  let money = 0;
  var numPlayers = 0;
  var joined = 0;
  var hand = [];
  var swapCard1 = false;
  var swapCard2 = false;
  var swapCard3 = false;
  var swapCard4 = false;
  var swapCard5 = false;
  var swapping = false;
  var name, call, round;
  var folded = false;
  //When client receives data from server
  connection.onmessage = function (evt) {
    var msg;
    msg = evt.data;
    console.log("Message received: " + msg);
    const obj = JSON.parse(msg);

    //We want to see if game has started first, 
    //so we can speed up the process and ignore other
    //conditions since .started only triggers with 
    //the toggle button
    if(obj.started == true && started == false){
      started = true;
      document.getElementById("switch").style.visibility = "hidden";
      var send_msg = {
        event: "SEND_HAND",
        playerID: playerID
      }
      connection.send(JSON.stringify(send_msg));
      start();
    }
    else{
      if(obj.your_ID){
        playerID = obj.Id;       
        console.log("Player id is now " + playerID); 
      }
      if(obj.numPlayers){
        //console.log("numPlayersChanging: " + obj.numPlayers);
        numPlayers = obj.numPlayers;
        if(joined){
          for(var i = 1; i <= numPlayers; i++){
            var column = document.getElementById("player" + i);
            column.style.visibility = "visible";
          }
        }
      }
      if(obj.playerNames){
        for(var i = 0; i < numPlayers; i++){
          //console.log("Players names be:" + obj.playerNames[i]);
          var player_name = document.getElementById("player" + (i+1) + "_name");
          player_name.innerText = obj.playerNames[i];
        }
      }
      if(obj.your_hand){
        hand = [];
        for(var i in obj.your_hand){
          hand.push(obj.your_hand[i]);
        }
        displayCards();
        //console.log("Hand Variable in JSON: " + JSON.stringify(hand));
      }
      
      if(obj.players_money){
        money = obj.players_money[playerID-1];
        updateMoney(money);
      }
      //Constantly update the pot
      if(obj.pot){
        document.getElementById("Pot").innerText = "Pot: $" + obj.pot;
      }
      if(obj.calls){
        console.log("Call = " + obj.calls[playerID - 1]);
        call = obj.calls[playerID - 1];
        if(call <= 0){
          document.getElementById("Call").innerText = "Call: $0";
        }
        else{
          document.getElementById("Call").innerText = "Call: $" + call;
        }
      }
      if(obj.turn){
        round = obj.round;
        if(round == 0 || round == 2){
          var playable_buttons = document.querySelectorAll(".playable_button");
          if(obj.turn == playerID){
            console.log("Your turn");
            playable_buttons.forEach((button) => {
              console.log("Enabling all buttons");
              button.disabled = false;
            })
            if(call <= 0){
              console.log("disabling call button");
              document.getElementById("call_button").disabled = true;
            }
            else{
              console.log("disabling check button");
              document.getElementById("check_button").disabled = true;
            }
          }
          else{
            playable_buttons.forEach((button) => {
            button.disabled = true;
            })
          }
        }
        if(obj.round == 1){
          var playable_buttons = document.querySelectorAll(".playable_button");
          playable_buttons.forEach((button) => {
            button.disabled = true;
          });
          swapping = true;
          var swap_button = document.getElementById("swap_button");
          swap_button.disabled = false;
        }
      }
    }
  }
  function join(){
    name = document.getElementById("send_name").value;
    var msg = {
      event: "JOIN",
      playerID: playerID,
      name: name
    };
    //Send message to WebPoker that new player has pressed join button
    connection.send(JSON.stringify(msg));

    console.log("Name is: " + name);
    document.getElementById("player" + playerID + "_name").innerText = name;

    //Remove enter name text input and join button
    var name_input = document.getElementById("send_name");
    name_input.style.display = "none";
    var join_btn = document.getElementById("join_button");
    join_btn.parentNode.removeChild(join_btn);

    //Keep track if player has joined, in order to see
    //if html needs to display players or not
    joined = 1;

    //for loop to display every player that is on
    for(var i = 1; i <= numPlayers; i++){
      var column = document.getElementById("player" + i);
      column.style.visibility = "visible";
    }
    var ready_btn = document.getElementById("switch");
    ready_btn.style.visibility = "visible";
  }

  function tutorial(){
    document.getElementById("tutorial").style.width = "100%"
  }
  function closeTutorial() {
    document.getElementById("tutorial").style.width = "0%";
  }

  function ready(){
    var ready_switch = document.getElementById("ready_switch");
    var msg = {
      event: "READY",
      playerID: playerID,
      status: ready_switch.checked
    }
    connection.send(JSON.stringify(msg));
  }

  async function start(){
    document.getElementById("timer_overlay").style.width = "100%";
    var timer_text = document.getElementById("timer");
    for(var i = 1; i >= 0; i += 0){
      setTimer(timer_text, i);
      await delay(1);
      i--;
    }
    document.getElementById("timer_overlay").style.width = "0%";
    //Now we hide the lobby screen after time
    var screen = document.getElementById("beginning");
    var screen2 = document.getElementById("middle");
    var title = document.getElementById("title");
    displayCards();

    //If not first player, automatically disabled buttons at start
    if(playerID != 1){
      var playable_buttons = document.querySelectorAll(".playable_button");
      playable_buttons.forEach((button) => {
        button.disabled = true;
      });
    }
    else{
      document.getElementById("call_button").disabled = true;
    }
    screen.style.display = "none";
    screen2.style.display = "revert";
    title.style.display = "none";
    //Set lobby screen back:
    //screen.style.display = "revert";
  }

  function delay(n){
    return new Promise(function(resolve){
      setTimeout(resolve, n*1000);
    });
  }

  async function setTimer(timer_text, i){
    await delay(1);
    timer_text.innerHTML = "Game starting: " + i;
  }

  function check(){
    var msg = {
      event: "MOVE",
      move: "CHECK",
      playerID: playerID
    }
    connection.send(JSON.stringify(msg));
  }

  function callFunct(){
    var msg = {
      event: "MOVE",
      move: "CALL",
      playerID: playerID
    }
    connection.send(JSON.stringify(msg));
  }

  function fold(){
    var msg = {
      event: "MOVE",
      move: "FOLD",
      playerID: playerID
    }
    connection.send(JSON.stringify(msg));
  }

  function raise(){
    var amt = document.getElementById("raise_amount").value;
    var msg = {
      event:"MOVE",
      move:"RAISE",
      raise: amt,
      playerID: playerID
    }
    connection.send(JSON.stringify(msg));
  }
  function updateMoney(amount){
    var balance = document.getElementById("Balance");
        balance.innerText = "Balance: $" + amount;
        console.log("Money now: " + amount);
  }

  function swap(card){
    if(round == 1 && swapping){
      console.log("Card element as: " + card.id);
      if(card.style.width == "130px"){
        switch(card.id){
          case "card1":
            swapCard1 = true;
            break;
          case "card2":
            swapCard2 = true;
            break;
          case "card3":
            swapCard3 = true;
            break;
          case "card4":
            swapCard4 = true;
            break;
          case "card5":
            swapCard5 = true;
            break;
        }
        card.style.width = "150px";
      }
      else{
        card.style.width = "130px";
        switch(card.id){
          case "card1":
            swapCard1 = false;
            break;
          case "card2":
            swapCard2 = false;
            break;
          case "card3":
            swapCard3 = false;
            break;
          case "card4":
            swapCard4 = false;
            break;
          case "card5":
            swapCard5 = false;
            break;
        }
      }
    }
    for(var i = 0; i < 5; i++){

    }
  }

  function sendSwap(){
    document.getElementById("swap_button").disabled = true;
    swapping = false;
    var msg = {
      event: "SWAP",
      playerID: playerID,
      swapCard1: swapCard1,
      swapCard2: swapCard2,
      swapCard3: swapCard3,
      swapCard4: swapCard4,
      swapCard5: swapCard5
    }
    connection.send(JSON.stringify(msg));
    var cards;
    for(var i = 1; i <= 5; i++){
      cards = document.getElementById("card" + i);
      cards.style.width = "130px";
    }
  }

  function displayCards(){
    var cardView, card;

    for(var i = 0; i < 5; i++){
      card = "";
      cardView = document.getElementById("card" + (i+1));
      //console.log("hand[i]: " + JSON.stringify(hand[i]));
      switch(hand[i]["value"]){
        case "TWO": 
          card += "2";
          break;
        case "THREE": 
          card += "3";
          break;
        case "FOUR": 
          card += "4";
          break;
        case "FIVE": 
          card += "5";
          break;    
        case "SIX": 
          card += "6";
          break;
        case "SEVEN": 
          card += "7";
          break;
        case "EIGHT": 
          card += "8";
          break;  
        case "NINE": 
          card += "9";
          break;  
        case "TEN": 
          card += "T";
          break;  
        case "JACK": 
          card += "J";
          break;  
        case "QUEEN": 
          card += "Q";
          break;  
        case "KING": 
          card += "K";
          break;  
        case "ACE": 
          card += "A";
          break;        
      }
      switch(hand[i]["suite"]){
        case "CLUBS":
          card += "C";
          break;
        case "SPADES":
          card += "S";
          break;
        case "DIAMONDS":
          card += "D";
          break;
        case "HEARTS":
          card += "H";
          break;
      }
      card += ".svg";
      console.log(card);
      cardView.src = card;
    }
  }
</script>